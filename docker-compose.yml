services:
  # ----------------------------------------------------------------
  # 1. Database (Mocking Supabase)
  # ----------------------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: goodwe-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: goodwe_hub
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------
  # 2. MQTT Broker (Mocking CloudAMQP/HiveMQ)
  # ----------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: goodwe-mqtt
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: hub_api
      RABBITMQ_DEFAULT_PASS: hub_secret
    ports:
      - "5672:5672" # AMQP
      - "1883:1883" # MQTT (plugin)
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "check_running" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------
  # 3. Hub API (FastAPI)
  # ----------------------------------------------------------------
  hub-api:
    build:
      context: ./hub-api
      dockerfile: Dockerfile
    container_name: goodwe-hub-api
    restart: always
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:password@db:5432/goodwe_hub
      MQTT_BROKER: rabbitmq
      MQTT_PORT: 1883
      AMQP_PORT: 5672
      MQTT_USER: hub_api
      MQTT_PASS: hub_secret
    volumes:
      - ./hub-api:/app # Hot reload

  # ----------------------------------------------------------------
  # 4. Hub Dashboard (React / Vite)
  # ----------------------------------------------------------------
  hub-dashboard:
    image: node:20-alpine
    container_name: goodwe-hub-dashboard
    working_dir: /app
    volumes:
      - ./hub-dashboard:/app
    ports:
      - "5173:5173"
    command: sh -c "npm install && npm run dev -- --host"
    depends_on:
      - hub-api

  # ----------------------------------------------------------------
  # 5. Edge Node (Mock Agent)
  # ----------------------------------------------------------------
  edge-node:
    build:
      context: ./edge
      dockerfile: Dockerfile
    container_name: goodwe-edge-node
    restart: always
    environment:
      MQTT_BROKER: rabbitmq
      MQTT_PORT: 1883
      MQTT_USER: mock-node-01
      MQTT_PASS: secret123
      NODE_ID: mock-node-01
      PUBLISH_INTERVAL: 2
    depends_on:
      - rabbitmq

volumes:
  db_data:
  rabbitmq_data:
  mqtt_data:
  mqtt_log:
